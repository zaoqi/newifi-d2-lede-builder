name: CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint
    - name: Run
      env:
        ID_RSA: ${{ secrets.ID_RSA }}
        ID_RSA_PUB: ${{ secrets.ID_RSA_PUB }}
      run: |
        git clone --depth 1 https://github.com/coolsnowwolf/lede.git
        cd lede
        ./scripts/feeds update -a && ./scripts/feeds install -a
        cp ../.config ./
        make -j4 V=s
        
        rm -fr $(find -name .gitignore) $(find -name .git)
        mv README README-lede.md
        
        git config --global user.email zaomir@outlook.com
        git config --global user.name zaoqi
        mkdir -p "$HOME/.ssh"
        echo "$ID_RSA" > "$HOME/.ssh/id_rsa"
        chmod 600 "$HOME/.ssh/id_rsa"
        echo "$ID_RSA_PUB" > "$HOME/.ssh/id_rsa.pub"
        chmod 644 "$HOME/.ssh/id_rsa.pub"
        ssh-keyscan -H -t rsa github.com > "$HOME/.ssh/known_hosts"
        chmod 644 "$HOME/.ssh/known_hosts"
        git clone --depth 1 git@github.com:zaoqi/newifi-d2-lede-binary.git
        mv newifi-d2-lede-binary/.git newifi-d2-lede-binary/README.md ./
        rm -fr newifi-d2-lede-binary
        git add .
        git commit -m .
        git push
